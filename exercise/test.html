<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMIR Learning Application</title>
    <link rel="stylesheet" href="style.css">    
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="container">
        <div class="frame">
            <h1>MMIR Learning Application</h1>
            
            <!-- Topic Selection Screen -->
            <div id="modeSelection">
                <div class="mode-selector">
                    <button class="mode-btn" data-mode="learn">Learn Mode</button>
                    <button class="mode-btn" data-mode="test">Test Mode</button>
                </div>
            </div>

            <!-- Topic Selection Screen -->
            <div id="topicSelection" class="hidden">
                <h2 data-mode="learn">Select topics to learn</h2>
                <h2 data-mode="test">Select number of questions</h2>
                <div class="card-grid" id="cardGrid"></div>
            </div>

            <!-- Quiz Screen -->
            <div id="quizScreen" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="back-btn" onclick="backToTopics()">← Back</button>
                    <div id="questionCounter"></div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="question-container">
                    <div class="question-text" id="questionText"></div>
                    <div class="options-container" id="optionsContainer"></div>
                    <div id="feedbackContainer"></div>
                    <button class="next-btn" id="nextBtn" onclick="nextQuestion()" disabled>Next Question</button>
                </div>
            </div>
            
            <!-- Results Screen -->
            <div id="resultsScreen" class="hidden">
                <div class="results-container">
                    <h2>Quiz Complete!</h2>
                    <div class="score-display" id="scoreDisplay"></div>
                    <div class="pass-status" id="passStatus"></div>
                    <button class="next-btn" onclick="backToTopics()">Try Another Topic</button>
                </div>
                <div id="reviewSection" class="review-section hidden"></div>
            </div>
        </div>
    </div>

    <script>


        // Quiz state
        let currentMode = '';
        let selectedTopics = [];
        let selectedPercentage = 0;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let selectedAnswer = null;
        let quizComplete = false;
        let quizData = {}


        function setupModeButtons() {
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    modeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    
                    // Update body class based on mode
                    document.body.classList.remove('learn-mode', 'test-mode');
                    document.body.classList.add(currentMode + '-mode');
                    document.getElementById('topicSelection').classList.remove('hidden');
                    
                    // Select mode and show corresponding parameterization page
                    if (currentMode === "learn") {
                        displayLearnSelection()
                    } else {
                        displayTestSelection()
                    }
                });
            });
            // Set initial mode class
            document.body.classList.add('learn-mode');
        }

        function displayLearnSelection() {

            function updateQuestions() {
                // Fetch all questions
                currentQuestions = selectedTopics.reduce((set, t) => set.concat(quizData[t]),[])
                
                // Update start button
                const startBtn = document.getElementById('startQuizBtn');
                startBtn.textContent = `Start Quiz (${currentQuestions.length} questions)`;
                startBtn.disabled = currentQuestions.length === 0;
            }

            function toggleTopic(topic, topicCard) {
                const index = selectedTopics.indexOf(topic);
                if (index === -1) {
                    // Add topic to selection
                    selectedTopics.push(topic);
                    topicCard.classList.add('selected');
                } else {
                    // Remove topic from selection
                    selectedTopics.splice(index, 1);
                    topicCard.classList.remove('selected');
                }
                updateQuestions()
            }


            const cardGrid = document.getElementById('cardGrid');
            cardGrid.innerHTML = '';
            
            // Add topic cards
            Object.keys(quizData).forEach(topic => {
                const topicCard = document.createElement('div');
                topicCard.className = 'card';
                topicCard.dataset.topic = topic;
                topicCard.innerHTML = `
                    <div class="card-selection-icon">✓</div>
                    <h3>${topic}</h3>
                    <p>${quizData[topic].length} questions</p>
                `;
                topicCard.addEventListener('click', () => toggleTopic(topic, topicCard));
                cardGrid.appendChild(topicCard);
                if (selectedTopics.indexOf(topic) >=0) 
                    topicCard.classList.add('selected')
            });

            // Add start quiz button container
            const startButtonContainer = document.createElement('div');
            startButtonContainer.className = 'start-button-container';
            startButtonContainer.innerHTML = `
                <button id="startQuizBtn" class="next-btn" disabled>
                    Start Quiz (0 questions)
                </button>
            `;

            // Add event listener to start button
            document.getElementById('cardGrid').appendChild(startButtonContainer);
            document.getElementById('startQuizBtn').addEventListener('click', () => {
                if (currentQuestions.length > 0) {
                    startQuiz();
                }
            });

            updateQuestions()
        }

        function displayTestSelection() {

            function updateQuestions() {
                // Get total number of questions across all topics
                const allQuestions = Object.values(quizData).flat();
                const numQuestions = Math.ceil((selectedPercentage/100) * allQuestions.length);
    
                // Shuffle and select subset
                shuffleArray(allQuestions);
                currentQuestions = allQuestions.slice(0, numQuestions);

                // Update start button
                const startBtn = document.getElementById('startQuizBtn');
                startBtn.textContent = `Start Quiz (${currentQuestions.length} questions)`;
                startBtn.disabled = currentQuestions.length === 0;
            }

            function togglePercentage(percentage, cardGrid, topicCard) {
                selectedPercentage = percentage;

                // unselect all other cards
                const cards = cardGrid.querySelectorAll('.card');
                cards.forEach(card => card.classList.remove('selected'));                

                // select current card
                topicCard.classList.add('selected');
                updateQuestions()
            }

            const cardGrid = document.getElementById('cardGrid');
            cardGrid.innerHTML = '';
            
            // Add percantage cards
            [20, 40, 60, 80, 100].forEach(percentage => {
                const topicCard = document.createElement('div');
                topicCard.className = 'card';
                topicCard.dataset.percentage = percentage;
                topicCard.innerHTML = `
                    <div class="card-selection-icon">✓</div>
                    <h3>${percentage} %</h3>
                    <p>nnn questions</p>
                `;
                topicCard.addEventListener('click', () => togglePercentage(percentage, cardGrid, topicCard));
                cardGrid.appendChild(topicCard);
                if (selectedPercentage === percentage) 
                    topicCard.classList.add('selected')
            });

            // add start quiz button
            const startButtonContainer = document.createElement('div');
            startButtonContainer.className = 'start-button-container';
            startButtonContainer.innerHTML = `
                <button id="startQuizBtn" class="next-btn" disabled>
                    Start Quiz (0 questions)
                </button>
            `;

            // Add event listener to start button
            document.getElementById('cardGrid').appendChild(startButtonContainer);
            document.getElementById('startQuizBtn').addEventListener('click', () => {
                if (currentQuestions.length > 0) {
                    startTest();
                }
            });
            updateQuestions()
        }

        function startQuiz() {
            // Shuffle questions
            shuffleArray(currentQuestions);
            
            currentQuestionIndex = 0;
            userAnswers = [];
            selectedAnswer = null;
            quizComplete = false;
            
            document.getElementById('topicSelection').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            
            displayQuestion();
        }
        

        
        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function displayQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            const questionCounter = document.getElementById('questionCounter');
            const progressFill = document.getElementById('progressFill');
            const questionText = document.getElementById('questionText');
            const optionsContainer = document.getElementById('optionsContainer');
            const feedbackContainer = document.getElementById('feedbackContainer');
            const nextBtn = document.getElementById('nextBtn');
            
            // Update progress
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            progressFill.style.width = progress + '%';
            questionCounter.textContent = `Question ${currentQuestionIndex + 1} of ${currentQuestions.length}`;
            
            // Display question
            questionText.textContent = question.question;
            
            // Clear previous state
            optionsContainer.innerHTML = '';
            feedbackContainer.innerHTML = '';
            selectedAnswer = null;
            nextBtn.disabled = true;
            nextBtn.textContent = currentQuestionIndex === currentQuestions.length - 1 ? 'Finish Quiz' : 'Next Question';
            
            // Display options
            question.options.forEach((option, index) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn';
                optionBtn.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                optionBtn.addEventListener('click', () => selectAnswer(index, optionBtn));
                optionsContainer.appendChild(optionBtn);
            });
        }

        function selectAnswer(answerIndex, btnElement) {
            // Remove previous selections
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            
            selectedAnswer = answerIndex;
            btnElement.classList.add('selected');
            
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = answerIndex === question.correct;
            
            if (currentMode === 'learn') {
                // Show immediate feedback
                showFeedback(isCorrect, question);
                
                // Highlight correct/incorrect
                document.querySelectorAll('.option-btn').forEach((btn, index) => {
                    if (index === question.correct) {
                        btn.classList.add('correct');
                    } else if (index === answerIndex && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                });
            }
            
            document.getElementById('nextBtn').disabled = false;
        }

        function showFeedback(isCorrect, question) {
            const feedbackContainer = document.getElementById('feedbackContainer');
            const feedback = document.createElement('div');
            feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedback.innerHTML = `
                <strong>${isCorrect ? 'Correct!' : 'Incorrect!'}</strong><br>
                ${question.explanation}
            `;
            feedbackContainer.appendChild(feedback);
        }

        function nextQuestion() {
            // Save answer
            userAnswers[currentQuestionIndex] = selectedAnswer;
            
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            // Calculate score
            let correctAnswers = 0;
            userAnswers.forEach((answer, index) => {
                if (answer === currentQuestions[index].correct) {
                    correctAnswers++;
                }
            });
            
            const percentage = Math.round((correctAnswers / currentQuestions.length) * 100);
            const passed = percentage >= 80;
            
            // Display score
            const scoreDisplay = document.getElementById('scoreDisplay');
            const passStatus = document.getElementById('passStatus');
            
            scoreDisplay.textContent = `${percentage}%`;
            scoreDisplay.className = `score-display ${passed ? 'pass' : 'fail'}`;
            
            passStatus.textContent = passed ? 'PASSED' : 'FAILED';
            passStatus.className = `pass-status ${passed ? 'pass' : 'fail'}`;
            
            // Show detailed review for test mode
            if (currentMode === 'test') {
                showReview();
            }
        }

        function showReview() {
            const reviewSection = document.getElementById('reviewSection');
            reviewSection.classList.remove('hidden');
            reviewSection.innerHTML = '<h3>Review:</h3>';
            
            currentQuestions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correct;
                
                const reviewItem = document.createElement('div');
                reviewItem.className = `review-item ${isCorrect ? 'correct' : 'incorrect'}`;
                reviewItem.innerHTML = `
                    <strong>Q${index + 1}: ${question.question}</strong><br>
                    <span class="topic-tag">${question.topic}</span><br>
                    Your answer: ${question.options[userAnswer]}<br>
                    ${!isCorrect ? `Correct answer: ${question.options[question.correct]}<br>` : ''}
                    <em>${question.explanation}</em>
                `;
                reviewSection.appendChild(reviewItem);
            });
        }

        function backToTopics() {
            document.getElementById('topicSelection').classList.remove('hidden');
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            
            // Keep the selected topics highlighted
            selectedTopics.forEach(topic => {
                const topicCard = document.querySelector(`.topic-card[data-topic="${topic}"]`);
                if (topicCard) {
                    topicCard.classList.add('selected');
                }
            });
            
            // Update start button
            const startBtn = document.getElementById('startQuizBtn');
            if (startBtn) {
                startBtn.textContent = `Start Quiz (${selectedTopics.length} topics selected)`;
                startBtn.disabled = selectedTopics.length === 0;
            }
        }

        function startTest(questionCount) {
            // Collect all questions from all topics
            let allQuestions = [];
            Object.keys(quizData).forEach(topic => {
                const topicQuestions = quizData[topic].map(q => ({...q, topic: topic}));
                allQuestions = [...allQuestions, ...topicQuestions];
            });
            
            // Shuffle all questions
            shuffleArray(allQuestions);
            
            // Take only the requested number of questions
            currentQuestions = allQuestions.slice(0, questionCount);
            
            currentQuestionIndex = 0;
            userAnswers = [];
            selectedAnswer = null;
            quizComplete = false;
            
            document.getElementById('topicSelection').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            
            displayQuestion();
        }

        // Add this function to fetch topics from JSON file
        async function loadQuestionsFromServer() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) 
                    throw new Error('Failed to load topics');
                quizData = await response.json();
                Object.entries(quizData).forEach(([topic, questions]) => {
                    questions.topic = topic
                });                            
            } catch (error) {
                console.error('Error loading topics:', error);
                // Show error message to user
                const topicGrid = document.getElementById('topicGrid');
                topicGrid.innerHTML = '<p>Error loading topics. Please try again later.</p>';
            }
        }

        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const numberOfParticles = 20;
            
            for (let i = 0; i < numberOfParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize the app when page loads
        createParticles();
        setupModeButtons()
        loadQuestionsFromServer()
    </script>
</body>
</html>